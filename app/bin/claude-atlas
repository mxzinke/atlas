#!/bin/bash
# Claude Atlas Wrapper - Injects system prompt based on session type
set -euo pipefail

APP_DIR="/atlas/app"
WORKSPACE="/atlas/workspace"

# Parse arguments
MODE=""  # "worker" or "trigger"
RESUME=""
CLAUDE_ARGS=()

while [[ $# -gt 0 ]]; do
    case $1 in
        --mode)
            MODE="$2"
            shift 2
            ;;
        --resume)
            RESUME="$2"
            CLAUDE_ARGS+=(--resume "$RESUME")
            shift 2
            ;;
        *)
            CLAUDE_ARGS+=("$1")
            shift
            ;;
    esac
done

# Build system prompt content
SYSTEM_PROMPT=""


if [ "$MODE" = "worker" ]; then
    # Worker sessions: add worker-system-prompt only (operational, no identity/soul)
    if [ -f "$APP_DIR/prompts/worker-system-prompt.md" ]; then
        SYSTEM_PROMPT="$SYSTEM_PROMPT

---

$(cat "$APP_DIR/prompts/worker-system-prompt.md")"
    fi

elif [ "$MODE" = "trigger" ]; then
    # Trigger sessions: add trigger-system-prompt (communication style/restrictions) + soul + identity + trigger-specific prompts
    if [ -f "$APP_DIR/prompts/trigger-system-prompt.md" ]; then
        SYSTEM_PROMPT="$SYSTEM_PROMPT

---

$(cat "$APP_DIR/prompts/trigger-system-prompt.md")"
    fi

    if [ -f "$WORKSPACE/SOUL.md" ]; then
        SYSTEM_PROMPT="$SYSTEM_PROMPT

---

$(cat "$WORKSPACE/SOUL.md")"
    fi

    if [ -f "$WORKSPACE/IDENTITY.md" ]; then
        SYSTEM_PROMPT="$SYSTEM_PROMPT

---

$(cat "$WORKSPACE/IDENTITY.md")"
    fi

    CHANNEL="${ATLAS_TRIGGER_CHANNEL:-internal}"
    if [ -f "$APP_DIR/prompts/trigger-channel-${CHANNEL}.md" ]; then
        SYSTEM_PROMPT="$SYSTEM_PROMPT

---

$(cat "$APP_DIR/prompts/trigger-channel-${CHANNEL}.md")"
    fi
fi

# Build final claude arguments
FINAL_ARGS=()
if [ -n "$SYSTEM_PROMPT" ]; then
    FINAL_ARGS+=(--append-system-prompt "$SYSTEM_PROMPT")
fi
FINAL_ARGS+=("${CLAUDE_ARGS[@]}")

export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1
exec claude "${FINAL_ARGS[@]}"
